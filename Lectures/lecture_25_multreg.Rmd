---
title: "A World of Many Predictors"
css: style.css
output: revealjs::revealjs_presentation
---

## <font color="white">Fire!</font>{data-background="./mlr/fires.jpg"}
```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(car)
keeley <- read.csv("./mlr/Keeley_rawdata_select4.csv")
```
<br><br><br><br><br>
<blockquote style="background-color:yellow; font-size=12px; width:80%; ">Five year study of wildfires & recovery in Southern California shurblands in 1993. 90 plots (20 x 50m)<Br> (data from Jon Keeley et al.)</blockquote>

## Many Things may Influence Species Richness
```{r}
pairs(keeley)
```

## Q: How does Fire Influence Species Richness?
<p align="left">Possible causes:</p>

- Distance from a burned patch
- Fire Severity
- Habitat heterogeneity

## Our Model of How the World Works

$$ Diversity_i = \beta_0 + \beta_1Distance_i + \beta_2Severity_i + \beta_3Heterogeneity_i + \epsilon_i$$
<br>
$$\epsilon_i \sim N(0, \sigma) $$
<br><br><br>

>- Linear additive data generating process<br><br>
>- Normal error generating process

## Multiple Regression in 1 Slide

<img src="./mlr/regression2.png">

- We are looking at unique contribution of each predictor on a response<br><br>
- We are **controlling** for covariation between predictors

## Multiple Regression in R in 1 Slide
<br><br>
```{r mlr, echo=TRUE}
keeley <- read.csv("./mlr/Keeley_rawdata_select4.csv")

k_mod <- lm(rich ~ distance + firesev + hetero, data=keeley)
```

## Still the Assumption of Normal Residuals
```{r}
plot(k_mod, which=2)
```

## Still the Assumption of Normal Residuals
```{r}
ggplot(data.frame(res=residuals(k_mod)), aes(x=res)) +
  geom_histogram(fill="blue", bins=30)
```

## Still Must Inspect Fitted v. Residuals
```{r}
plot(k_mod, which=1)
```

## New Assumption: Low Collinearity Between Predictors

* If predictors are highly correlated fit might be bad
* High correlation can lead to inflated error in parameters
* Above ~0.8 is bad, no unique information from variables
<br><br>
```{r cormat}
with(keeley, cor(cbind(distance, firesev, hetero)))
```

## Second Test: Is Variance Inflated by Any Predictor?
Asks by what factor variance in parameter estimates is inflated by a predictor

```{r vif, echo=TRUE}
library(car)
vif(k_mod)
```
VIF > 5 or 10 can be problematic and indicate an unstable
solution.

## Evaluation: Importance of Predictors
- It's all about F-tests again!<br><br>
- Use type II sums of squares to evalute unique effect of predictor<br><br>
- `Anova` function from `car` library<br><br>
```{r}
knitr::kable(Anova(k_mod))
```


## Evaluation: Estimate of Predictors
- It's all about T-tests again!<br><br>
```{r}
knitr::kable(summary(k_mod)$coef)
```
$R^2$ = `r summary(k_mod)$r.squared`

## Visualization
>* Visualization is difficult with mutiple predictors
>       + How do you show effect of multiple continuous variables?
>* Strategy 1: Effect of one variable after accounting for effect of others
>* Strategy 2: Effect of one variable at different levels of others

##Plot Each Predictor at Median of Others
```{r visreg, warning=FALSE, message=FALSE, eval=FALSE, echo=TRUE}
library(visreg)
visreg(k_mod)
```

##Plot Each Predictor at Median of Others
```{r visreg2, warning=FALSE, message=FALSE}
library(visreg)
par(mfrow=c(2,2))
visreg(k_mod, cex.lab=1.3, cex=1.5, cex.axis=1.3)
par(mfrow=c(1,1))
```

##What about Interactions?
$$ Diversity_i = \beta_0 + \beta_1Age_i + \beta_2Severity_i + \beta_3Age_i*Severity_i + \epsilon_i$$

```{r}
k_mod_int <- lm(rich ~ age*firesev, data = keeley)
```

##Same Workflow
- Evaluate residuals, fitted v. residuals<br><br>
- Evaluate VIF and correlation of predictors<br><br>
- F, T-Tests, $R^2$<br><br>
- Visualization

##F-Tests
```{r}
knitr::kable(Anova(k_mod_int))
```

##Visualization of One Variable at Levels of Others
```{r echo=TRUE}
visreg(k_mod_int, "firesev", by="age")
```

##Split Data into Quantiles
```{r echo=TRUE, eval=FALSE}
#Make the breaks
keeley$age_breaks <- cut(keeley$age, 
                         breaks=quantile(keeley$age))

keeley$firesev_breaks <- cut(keeley$firesev, 
                         breaks=quantile(keeley$firesev))

#make the plot
ggplot(data = keeley, aes(x=firesev, y=rich)) +
  geom_point() +
  stat_smooth(method="lm") +
  facet_wrap(~age_breaks)
```

##Split Data into Quantiles
```{r}
keeley$age_breaks <- cut(keeley$age, 
                         breaks=quantile(keeley$age))
keeley$firesev_breaks <- cut(keeley$firesev, 
                         breaks=quantile(keeley$firesev))

ggplot(data = keeley, aes(x=firesev, y=rich, color=age_breaks)) +
  geom_point() +
  stat_smooth(method="lm") +
  facet_wrap(~age_breaks)
```